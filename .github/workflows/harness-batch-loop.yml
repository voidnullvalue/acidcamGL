name: Harness Batch Loop

on:
  workflow_dispatch:
  # schedule:
  #   - cron: '0 6 * * *' # Optional: enable for daily batch processing.

permissions:
  contents: write
  pull-requests: write

jobs:
  process-one-batch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Run Codex prompt (one-batch harness resume)
        id: codex
        # NOTE: If openai/codex-action input names change, update this step to match upstream docs.
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: .github/codex-prompts/harness_resume_batch.md
          working-directory: .
          approval-policy: never
          sandbox: danger-full-access

      - name: Log concise changed-file summary
        run: |
          echo "Changed files (post-Codex):"
          git status --short
          echo "---"
          git diff --name-only || true

      - name: Enforce docs-only file changes
        run: |
          set -euo pipefail
          changed_files="$(git diff --name-only)"
          if [[ -z "$changed_files" ]]; then
            echo "No changes detected."
            exit 0
          fi
          disallowed="$(echo "$changed_files" | rg -v '^(docs/harness/|\.github/codex-prompts/)')" || true
          if [[ -n "$disallowed" ]]; then
            echo "Disallowed file changes detected:" >&2
            echo "$disallowed" >&2
            exit 1
          fi

      - name: Prepare branch + commit metadata
        id: prep
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: scripts/harness/prepare_harness_pr.sh

      - name: Push branch
        if: steps.prep.outputs.has_changes == 'true'
        env:
          BRANCH_NAME: ${{ steps.prep.outputs.branch_name }}
        run: |
          set -euo pipefail
          git push --set-upstream origin "$BRANCH_NAME"

      - name: Create pull request
        if: steps.prep.outputs.has_changes == 'true' && steps.prep.outputs.status != 'BATCHING_COMPLETE'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ steps.prep.outputs.pr_title }}
          PR_BODY: ${{ steps.prep.outputs.pr_body }}
          BRANCH_NAME: ${{ steps.prep.outputs.branch_name }}
          BASE_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          gh pr create \
            --base "$BASE_BRANCH" \
            --head "$BRANCH_NAME" \
            --title "$PR_TITLE" \
            --body "$PR_BODY"

      - name: Skip PR when complete or no changes
        if: steps.prep.outputs.has_changes != 'true' || steps.prep.outputs.status == 'BATCHING_COMPLETE'
        run: |
          echo "No PR created."
          echo "has_changes=${{ steps.prep.outputs.has_changes }}"
          echo "status=${{ steps.prep.outputs.status }}"
          echo "If status is BATCHING_COMPLETE, harness batches are finished."

      # Optional future enhancement:
      # - Add a controlled auto-merge step here once your review policy allows it.
      #   Keep disabled by default for safety.
